---
// Individual Project Log Page - Shows full log entry with navigation
import contentCssUrl from '@/styles/content.css?url'
import { getCollection } from 'astro:content'
import type { CollectionEntry } from 'astro:content'

import ProjectLogDetail from '@/components/pages/ProjectLogDetail.astro'
import BreadcrumbSchema from '@/components/primitives/seo/BreadcrumbSchema.astro'
import BaseLayout from '@/layouts/BaseLayout.astro'

export async function getStaticPaths() {
  const [projectLogs, projects] = await Promise.all([
    // Filter out drafts in production
    getCollection('projectLogs', ({ data }) => !import.meta.env.PROD || !data.draft),
    getCollection('projects'),
  ])

  return projectLogs.map((log: CollectionEntry<'projectLogs'>) => {
    // Extract project slug and log slug from log ID
    // Log ID format: "ai-ams/logs/2024-12-28-surelc-api.md"
    const projectSlug = log.id.split('/')[0]
    const logSlug = log.id.split('/logs/')[1].replace(/\.md$/, '')

    const project = projects.find((p) => p.id === projectSlug)

    // Find all logs for this project, sorted by date descending
    const projectLogsSorted = projectLogs
      .filter((l) => l.id.startsWith(`${projectSlug}/logs/`))
      .toSorted((a, b) => b.data.date.getTime() - a.data.date.getTime())

    // Find current log index
    const currentIndex = projectLogsSorted.findIndex((l) => l.id === log.id)

    // Get previous and next logs (remember: sorted newest to oldest)
    const nextLog = currentIndex > 0 ? projectLogsSorted[currentIndex - 1] : undefined
    const previousLog =
      currentIndex < projectLogsSorted.length - 1 ? projectLogsSorted[currentIndex + 1] : undefined

    return {
      params: { slug: projectSlug, logSlug },
      props: { log, project, previousLog, nextLog },
    }
  })
}

export interface Props {
  log: CollectionEntry<'projectLogs'>
  project?: CollectionEntry<'projects'>
  previousLog?: CollectionEntry<'projectLogs'>
  nextLog?: CollectionEntry<'projectLogs'>
}

const { log, project, previousLog, nextLog } = Astro.props

// Extract project slug for links
const projectSlug = log.id.split('/')[0]

const breadcrumbItems = [
  { name: 'Home', url: '/' },
  { name: 'Projects', url: '/projects' },
  ...(project
    ? [
        { name: project.data.title, url: `/projects/${projectSlug}` },
        { name: log.data.title, url: Astro.url.pathname },
      ]
    : [{ name: log.data.title, url: Astro.url.pathname }]),
]

const pageTitle = `${log.data.title} | ${project?.data.title ?? 'Project Log'}`
---

<BaseLayout title={pageTitle} description={log.data.title}>
  <link
    slot="head"
    rel="preload"
    href={contentCssUrl}
    as="style"
    onload="this.onload=null;this.rel='stylesheet'"
  />
  <noscript slot="head"><link rel="stylesheet" href={contentCssUrl} /></noscript>
  <BreadcrumbSchema slot="head" items={breadcrumbItems} />

  <main>
    <ProjectLogDetail {log} {project} {previousLog} {nextLog} />
  </main>
</BaseLayout>
