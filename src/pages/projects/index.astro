---
// Projects Index Page - Full listing of all projects
import { markLatestProjectAsLive, sortProjectsByLatestLog } from '@/lib/projects'
import BaseLayout from '@/layouts/BaseLayout.astro'
import { getCollection } from 'astro:content'
import type { CollectionEntry } from 'astro:content'
import ProjectsIndex from '@/components/pages/ProjectsIndex.astro'
import ItemListSchema from '@/components/primitives/seo/ItemListSchema.astro'
import { staticPages } from '@/config/pages'

// Fetch and sort projects by latest log
const projects = await getCollection('projects')
// Filter out drafts in production
const projectLogs = await getCollection(
  'projectLogs',
  ({ data }) => !import.meta.env.PROD || !data.draft,
)

const sortedProjects = sortProjectsByLatestLog(projects, projectLogs)
const projectsWithLive = markLatestProjectAsLive(sortedProjects, projectLogs)

const { title, description } = staticPages.projects
const ogImage = '/og/projects.png'

const projectListItems = projectsWithLive.map((project: CollectionEntry<'projects'>) => {
  // Normalize slug: remove '/index.md' or '/index' suffix if present
  const slug = project.id.replace(/\/index(\.md)?$/, '')
  return {
    name: project.data.title,
    url: `/projects/${slug}`,
    description: project.data.description,
  }
})
---

<BaseLayout {title} {description} image={ogImage}>
  <ItemListSchema slot="head" name="Projects" items={projectListItems} />
  <ProjectsIndex projects={projectsWithLive} />
</BaseLayout>
