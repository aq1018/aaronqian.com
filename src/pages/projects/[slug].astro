---
// Project Detail Page - Shows project info + log entries in reverse chronological order
import { getCollection } from 'astro:content'
import type { CollectionEntry } from 'astro:content'

import ProjectDetail from '@/components/pages/ProjectDetail.astro'
import BreadcrumbSchema from '@/components/primitives/seo/BreadcrumbSchema.astro'
import CreativeWorkSchema from '@/components/primitives/seo/CreativeWorkSchema.astro'
import BaseLayout from '@/layouts/BaseLayout.astro'

export async function getStaticPaths() {
  const projects = await getCollection('projects')

  return projects.map((project: CollectionEntry<'projects'>) => {
    // Normalize slug: remove '/index.md' or '/index' suffix if present
    const slug = project.id.replace(/\/index(\.md)?$/, '')
    return {
      params: { slug },
      props: { project },
    }
  })
}

export interface Props {
  project: CollectionEntry<'projects'>
}

const { project } = Astro.props

// Normalize project slug for log filtering
const projectSlug = project.id.replace(/\/index(\.md)?$/, '')

// Fetch all logs for this project, sorted by date descending
const allLogs = await getCollection('projectLogs')
const projectLogs = allLogs
  .filter((log: CollectionEntry<'projectLogs'>) => log.id.startsWith(`${projectSlug}/logs/`))
  .toSorted(
    (a: CollectionEntry<'projectLogs'>, b: CollectionEntry<'projectLogs'>) =>
      b.data.date.getTime() - a.data.date.getTime(),
  )

// Status badge styles
const statusStyles = {
  active: 'bg-primary/20 text-primary border-primary/40',
  done: 'bg-content/20 text-content/60 border-content/40',
  planning: 'bg-muted/20 text-muted border-border',
}

const statusLabels = {
  active: 'ACTIVE',
  done: 'DONE',
  planning: 'PLANNING',
}

const ogImage = `/og/projects/${projectSlug}.png`

const breadcrumbItems = [
  { name: 'Home', url: '/' },
  { name: 'Projects', url: '/projects' },
  { name: project.data.title, url: `/projects/${projectSlug}` },
]

// Use earliest log date as creation date, or current date if no logs
const creationDate = projectLogs.length > 0 ? projectLogs.at(-1)!.data.date : new Date()
---

<BaseLayout title={project.data.title} description={project.data.description} image={ogImage}>
  <BreadcrumbSchema slot="head" items={breadcrumbItems} />
  <CreativeWorkSchema
    slot="head"
    name={project.data.title}
    description={project.data.description}
    dateCreated={creationDate}
    url={`/projects/${projectSlug}`}
    image={ogImage}
  />
  <ProjectDetail {project} {projectLogs} {statusStyles} {statusLabels} />
</BaseLayout>
