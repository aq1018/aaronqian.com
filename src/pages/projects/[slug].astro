---
// Project Detail Page - Shows project info + log entries in reverse chronological order
import { type CollectionEntry, getCollection } from 'astro:content'

import ProjectDetail from '@/components/pages/ProjectDetail.astro'
import BaseLayout from '@/layouts/BaseLayout.astro'

export async function getStaticPaths() {
  const projects = await getCollection('projects')

  return projects.map((project) => {
    // Normalize slug: remove '/index.md' or '/index' suffix if present
    const slug = project.id.replace(/\/index(\.md)?$/, '')
    return {
      params: { slug },
      props: { project },
    }
  })
}

export interface Props {
  project: CollectionEntry<'projects'>
}

const { project } = Astro.props

// Normalize project slug for log filtering
const projectSlug = project.id.replace(/\/index(\.md)?$/, '')

// Fetch all logs for this project, sorted by date descending
const allLogs = await getCollection('projectLogs')
const projectLogs = allLogs
  .filter((log) => log.data.project === projectSlug)
  .sort((a, b) => b.data.date.getTime() - a.data.date.getTime())

// Status badge styles
const statusStyles = {
  active: 'bg-primary/20 text-primary border-primary/40',
  planning: 'bg-muted/20 text-muted border-border',
  done: 'bg-content/20 text-content/60 border-content/40',
}

const statusLabels = {
  active: 'ACTIVE',
  planning: 'PLANNING',
  done: 'DONE',
}
---

<BaseLayout title={project.data.title} description={project.data.description}>
  <ProjectDetail {project} {projectLogs} {statusStyles} {statusLabels} />
</BaseLayout>
