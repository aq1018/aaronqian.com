---
// Project Detail Page - Shows project info + log entries in reverse chronological order
import { getCollection, render } from 'astro:content'
import type { CollectionEntry } from 'astro:content'

import ProjectDetail from '@/components/pages/ProjectDetail.astro'
import BreadcrumbSchema from '@/components/primitives/seo/BreadcrumbSchema.astro'
import CreativeWorkSchema from '@/components/primitives/seo/CreativeWorkSchema.astro'
import BaseLayout from '@/layouts/BaseLayout.astro'
import { getProjectSlug } from '@/lib/projects'

export async function getStaticPaths() {
  const projects = await getCollection('projects')

  return projects.map((project: CollectionEntry<'projects'>) => ({
    params: { slug: getProjectSlug(project) },
    props: { project },
  }))
}

export interface Props {
  project: CollectionEntry<'projects'>
}

const { project } = Astro.props
const projectSlug = getProjectSlug(project)

// Render project content if it has a body
const hasProjectContent = project.body && project.body.trim() !== ''
let Content = null
if (hasProjectContent) {
  const rendered = await render(project)
  Content = rendered.Content
}

// Fetch all logs for this project, sorted by date descending
// Filter out drafts in production
const allLogs = await getCollection(
  'projectLogs',
  ({ data }) => !import.meta.env.PROD || !data.draft,
)
const projectLogs = allLogs
  .filter((log: CollectionEntry<'projectLogs'>) => log.id.startsWith(`${projectSlug}/logs/`))
  .toSorted(
    (a: CollectionEntry<'projectLogs'>, b: CollectionEntry<'projectLogs'>) =>
      b.data.date.getTime() - a.data.date.getTime(),
  )

// Status badge styles
const statusStyles = {
  'in-development': 'bg-muted/20 text-muted border-border',
  active: 'bg-primary/20 text-primary border-primary/40',
  completed: 'bg-content/20 text-content/60 border-content/40',
  'up-for-adoption': 'bg-warning/20 text-warning border-warning/40',
}

const statusLabels = {
  'in-development': 'IN DEVELOPMENT',
  active: 'ACTIVE',
  completed: 'COMPLETED',
  'up-for-adoption': 'UP FOR ADOPTION',
}

const ogImage = `/og/projects/${projectSlug}.png`

const breadcrumbItems = [
  { name: 'Home', url: '/' },
  { name: 'Projects', url: '/projects' },
  { name: project.data.title, url: `/projects/${projectSlug}` },
]

// Use earliest log date as creation date, or current date if no logs
const creationDate = projectLogs.length > 0 ? projectLogs.at(-1)!.data.date : new Date()
---

<BaseLayout title={project.data.title} description={project.data.description} image={ogImage}>
  <BreadcrumbSchema slot="head" items={breadcrumbItems} />
  <CreativeWorkSchema
    slot="head"
    name={project.data.title}
    description={project.data.description}
    dateCreated={creationDate}
    url={`/projects/${projectSlug}`}
    image={ogImage}
  />
  <ProjectDetail {project} {projectLogs} {statusStyles} {statusLabels}>
    {Content && <Content />}
  </ProjectDetail>
</BaseLayout>
