---
import type { CollectionEntry } from 'astro:content'
import { render } from 'astro:content'

import Comments from '@/components/features/Comments.astro'
import DraftBanner from '@/components/features/DraftBanner.astro'
import Badge from '@/components/primitives/Badge.astro'
import Cluster from '@/components/primitives/Cluster.astro'
import Container from '@/components/primitives/Container.astro'
import Divider from '@/components/primitives/Divider.astro'
import Heading from '@/components/primitives/Heading.astro'
import Link from '@/components/primitives/Link.astro'
import Prose from '@/components/primitives/Prose.astro'
import Stack from '@/components/primitives/Stack.astro'
import Surface from '@/components/primitives/Surface.astro'
import Text from '@/components/primitives/Text.astro'
import { getBlogDate } from '@/lib/blog'

export interface Props {
  post: CollectionEntry<'blog'>
}

const { post } = Astro.props
const publishDate = getBlogDate(post.id)
const lastUpdatedOn = post.data.lastUpdatedOn

// Check if last updated date is different from publish date
const showLastUpdated = publishDate.toDateString() !== lastUpdatedOn.toDateString()

const { Content } = await render(post)
---

{post.data.draft && <DraftBanner />}

<Surface>
  <Container width="narrow">
    <Stack space="lg">
      <Link href="/blog" variant="back"> ← Back to blog </Link>

      <Heading size="h1">
        {post.data.title}
      </Heading>

      <Stack space="xs">
        <Cluster space="md">
          <Cluster space="xs">
            <Text as="span" color="muted" size="small">Published on</Text>
            <Text as="span" color="muted" size="small">
              {
                publishDate.toLocaleDateString('en-US', {
                  year: 'numeric',
                  month: 'long',
                  day: 'numeric',
                })
              }
            </Text>
          </Cluster>
          {
            showLastUpdated && (
              <>
                <Text as="span" color="muted" size="small">
                  •
                </Text>
                <Cluster space="xs">
                  <Text as="span" color="muted" size="small">
                    Updated on
                  </Text>
                  <Text as="span" color="muted" size="small">
                    {lastUpdatedOn.toLocaleDateString('en-US', {
                      year: 'numeric',
                      month: 'long',
                      day: 'numeric',
                    })}
                  </Text>
                </Cluster>
              </>
            )
          }
        </Cluster>
        {
          post.data.tags && post.data.tags.length > 0 && (
            <Cluster space="xs">
              {post.data.tags.map((tag: string) => (
                <Badge color="neutral" size="sm">
                  {tag}
                </Badge>
              ))}
            </Cluster>
          )
        }
      </Stack>

      <Divider />

      <Prose size="base">
        <Content />
      </Prose>

      <Comments />
    </Stack>
  </Container>
</Surface>
