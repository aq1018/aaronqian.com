---
import type { CollectionEntry } from 'astro:content'

import Comments from '@/components/features/Comments.astro'
import ProjectLogEntry from '@/components/features/ProjectLogEntry.astro'
import Container from '@/components/primitives/Container.astro'
import Divider from '@/components/primitives/Divider.astro'
import Heading from '@/components/primitives/Heading.astro'
import IconLink from '@/components/primitives/IconLink.astro'
import Link from '@/components/primitives/Link.astro'
import Prose from '@/components/primitives/Prose.astro'
import Stack from '@/components/primitives/Stack.astro'
import StatusBadge from '@/components/primitives/StatusBadge.astro'
import Surface from '@/components/primitives/Surface.astro'
import Text from '@/components/primitives/Text.astro'
import { getProjectSlug } from '@/lib/projects'

export interface Props {
  project: CollectionEntry<'projects'>
  projectLogs: CollectionEntry<'projectLogs'>[]
}

const { project, projectLogs } = Astro.props
const hasContent = Astro.slots.has('default')
const projectSlug = getProjectSlug(project)

// Get latest 3 logs for compact display
const latestLogs = projectLogs.slice(0, 3)

// Format date for compact display
const formatDate = (date: Date) => {
  const year = date.getFullYear()
  const month = String(date.getMonth() + 1).padStart(2, '0')
  const day = String(date.getDate()).padStart(2, '0')
  return `${year}-${month}-${day}`
}
---

<!-- Project Header -->
<header>
  <Surface>
    <Container>
      <Stack space="md">
        <!-- Back link -->
        <Link href="/projects" variant="back"> ← Back to projects </Link>

        <!-- Title and status -->
        <Stack space="md" class="flex-wrap" align="baseline">
          <Heading size="h1" class="text-3xl sm:text-4xl">
            {project.data.title}
          </Heading>
          <Stack direction="row" space="sm">
            <StatusBadge status={project.data.status} size="sm" />
            {
              project.data.links && (
                <Stack direction="row" space="xs">
                  {project.data.links.site && (
                    <IconLink
                      href={project.data.links.site}
                      icon="heroicons:globe-alt"
                      label="Visit site"
                      size="md"
                    />
                  )}
                  {project.data.links.github && (
                    <IconLink
                      href={project.data.links.github}
                      icon="simple-icons:github"
                      label="View on GitHub"
                      size="md"
                    />
                  )}
                  {project.data.links.docs && (
                    <IconLink
                      href={project.data.links.docs}
                      icon="heroicons:document-text"
                      label="Documentation"
                      size="md"
                    />
                  )}
                </Stack>
              )
            }
          </Stack>
        </Stack>

        <!-- Description -->
        <Text>
          {project.data.description}
        </Text>

        <!-- Aside (witty comment) -->
        <Text size="small" color="muted" class="italic">
          {project.data.aside}
        </Text>

        <Divider />

        <!-- Recent Activity -->
        {
          projectLogs.length > 0 && (
            <Stack space="sm">
              <Heading as="h2" size="h6" color="muted">
                Recent activity
              </Heading>
              <Stack space="xs">
                {latestLogs.slice(0, 2).map((log) => {
                  const logUrl = `/projects/${log.id.replace(/\.md$/, '')}`
                  return (
                    <div class="flex items-baseline gap-2">
                      <Text size="small" color="muted">
                        {formatDate(log.data.date)}
                      </Text>
                      <Link href={logUrl} variant="content" class="truncate text-sm">
                        {log.data.title}
                      </Link>
                    </div>
                  )
                })}
              </Stack>
              <Link href={`/projects/${projectSlug}/logs`} variant="content" class="text-sm">
                View all logs →
              </Link>
              <Divider />
            </Stack>
          )
        }
      </Stack>
    </Container>
  </Surface>
</header>

<!-- Project Content -->
<section>
  <Surface padY="sm">
    <Container>
      <Stack space="lg">
        {
          hasContent && (
            <Prose size="base">
              <slot />
            </Prose>
          )
        }

        {
          projectLogs.length > 0 && (
            <>
              {hasContent && <Divider />}
              <Stack space="sm">
                <Heading as="h2" size="h6" color="muted">
                  Latest logs
                </Heading>
                {projectLogs.slice(0, 2).map((log) => (
                  <ProjectLogEntry log={log} showExcerpt={true} />
                ))}
              </Stack>
              {projectLogs.length > 2 && (
                <Link href={`/projects/${projectSlug}/logs`} variant="content" class="text-sm">
                  View all {projectLogs.length} logs →
                </Link>
              )}
            </>
          )
        }
      </Stack>
    </Container>
  </Surface>
</section>

<!-- Comments -->
<section>
  <Surface>
    <Container>
      <Stack space="md">
        <Heading size="h2">Comments</Heading>
        <Comments />
      </Stack>
    </Container>
  </Surface>
</section>
