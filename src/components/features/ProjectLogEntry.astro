---
// ProjectLogEntry - Terminal-style log entry component
import { render } from 'astro:content'
import type { CollectionEntry } from 'astro:content'
import { marked } from 'marked'

import Badge from '@/components/primitives/Badge.astro'
import Heading from '@/components/primitives/Heading.astro'
import Prose from '@/components/primitives/Prose.astro'
import Sheet from '@/components/primitives/Sheet.astro'
import Stack from '@/components/primitives/Stack.astro'
import Text from '@/components/primitives/Text.astro'

export interface Props {
  log: CollectionEntry<'projectLogs'>
  showExcerpt?: boolean
}

const { log, showExcerpt = false } = Astro.props

// Extract excerpt with smart fallback
const getExcerpt = (body: string) => {
  if (body.includes('<!-- excerpt -->')) {
    return body.split('<!-- excerpt -->')[0]
  }
  // Fallback to first paragraph
  return body.split('\n\n')[0]
}

// Generate log URL from log ID: ai-ams/logs/2024-12-28-surelc-api.md -> /projects/ai-ams/logs/2024-12-28-surelc-api
const logUrl = `/projects/${log.id.replace(/\.md$/, '')}`

// Render content or excerpt
let contentHtml = ''
let Content: any = null

if (showExcerpt) {
  const excerptMarkdown = getExcerpt(log.body ?? '')
  contentHtml = await marked.parse(excerptMarkdown)
} else {
  const rendered = await render(log)
  Content = rendered.Content
}

// Format date as [YYYY-MM-DD HH:MM]
const formatTimestamp = (date: Date) => {
  const year = date.getFullYear()
  const month = String(date.getMonth() + 1).padStart(2, '0')
  const day = String(date.getDate()).padStart(2, '0')
  const hours = String(date.getHours()).padStart(2, '0')
  const minutes = String(date.getMinutes()).padStart(2, '0')
  return `${year}-${month}-${day} ${hours}:${minutes}`
}

// Tag color mappings for Badge component
const tagColorMap: Record<
  string,
  { color: 'primary' | 'danger' | 'info' | 'muted'; customClass?: string }
> = {
  bug: { color: 'danger' },
  experiment: { color: 'info' },
  milestone: { color: 'primary' },
  ux: { color: 'info' },
}

const getTagProps = (tag: string) => tagColorMap[tag.toLowerCase()] ?? { color: 'muted' }
---

<Sheet
  as="a"
  href={logUrl}
  variant="bar"
  color="neutral"
  padding="none"
  hover
  class="block pl-6 no-underline hover:no-underline"
>
  <!-- Timestamp and title -->
  <header class="mb-3">
    <Stack space="xs">
      <Text as="time" color="muted" datetime={log.data.date.toISOString()}>
        [{formatTimestamp(log.data.date)}]
      </Text>
      {
        log.data.draft && (
          <div class="w-fit">
            <Badge color="danger" size="sm" uppercase>
              DRAFT
            </Badge>
          </div>
        )
      }
    </Stack>
    <Heading size="h3" class="mt-1 text-lg">
      {log.data.title}
    </Heading>
  </header>

  <!-- Tags -->
  {
    log.data.tags.length > 0 && (
      <Stack direction="row" space="xs" class="mb-4 flex-wrap">
        {log.data.tags.map((tag: string) => (
          <Badge
            color={getTagProps(tag).color}
            size="xs"
            class={`px-2 ${getTagProps(tag).customClass ?? ''}`}
          >
            {tag}
          </Badge>
        ))}
      </Stack>
    )
  }

  <!-- Log content (markdown) -->
  <Prose>
    {showExcerpt ? <Fragment set:html={contentHtml} /> : <Content />}
  </Prose>

  <!-- Read more link for excerpts -->
  {
    showExcerpt && (
      <div class="mt-4">
        <span class="text-link underline">Read more â†’</span>
      </div>
    )
  }
</Sheet>
