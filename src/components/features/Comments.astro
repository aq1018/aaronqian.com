---
import {
  GISCUS_CATEGORY as CATEGORY,
  GISCUS_CATEGORY_ID as CATEGORY_ID,
  GISCUS_REPO as REPO,
  GISCUS_REPO_ID as REPO_ID,
} from 'astro:env/client'

export interface Props {
  class?: string
}

const { class: className } = Astro.props
const ORIGIN = Astro.url.origin
---

<div class={className} data-comments>
  <!-- Dynamically load Giscus with correct initial theme -->
  <script is:inline define:vars={{ REPO, REPO_ID, CATEGORY, CATEGORY_ID, ORIGIN }}>
    ;(function () {
      // Determine current theme using same logic as BaseLayout.astro
      const theme = localStorage.getItem('theme') || 'system'
      const isDark =
        theme === 'dark' ||
        (theme === 'system' && window.matchMedia('(prefers-color-scheme: dark)').matches)

      // Build theme URL
      // oxlint-disable-next-line no-undef
      const themeUrl = `${ORIGIN}/giscus-${isDark ? 'dark' : 'light'}.generated.css`

      const dataset = {
        // oxlint-disable-next-line no-undef
        repo: REPO,
        // oxlint-disable-next-line no-undef
        repoId: REPO_ID,
        // oxlint-disable-next-line no-undef
        category: CATEGORY,
        // oxlint-disable-next-line no-undef
        categoryId: CATEGORY_ID,
        mapping: 'pathname',
        strict: '1',
        reactionsEnabled: '1',
        emitMetadata: '0',
        inputPosition: 'top',
        theme: themeUrl,
        lang: 'en',
        loading: 'lazy',
      }

      // Create and configure Giscus script
      const script = document.createElement('script')
      script.src = 'https://giscus.app/client.js'
      script.dataset = dataset
      script.setAttribute('crossorigin', 'anonymous')
      script.async = true

      // Append to comments container
      document.currentScript.parentElement.append(script)
    })()
  </script>
</div>
