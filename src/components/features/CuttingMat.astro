---
/**
 * Cutting mat background component
 * Technical grid with optional measurement overlays
 */

import { defaultOptions } from './CuttingMat.config'
import type { CuttingMatOptions } from './CuttingMat.types'
import AngleLabels from './CuttingMatAngleLabels.astro'
import AngleLines from './CuttingMatAngleLines.astro'
import AngleMarks from './CuttingMatAngleMarks.astro'
import Arcs from './CuttingMatArcs.astro'
import Axes from './CuttingMatAxes.astro'
import GridLines from './CuttingMatGridLines.astro'
import TeethMarks from './CuttingMatTeethMarks.astro'

export interface Props extends Partial<CuttingMatOptions> {
  class?: string
}

const { class: className, ...options } = Astro.props

// Merge with defaults
const config = { ...defaultOptions, ...options }

// Use last arc if angleLabelArcIndex is -1
const labelArcIndex =
  config.angleLabelArcIndex === -1 ? config.arcCount - 1 : config.angleLabelArcIndex
const finalConfig = { ...config, angleLabelArcIndex: labelArcIndex }

// ViewBox dimensions for coordinate system
const viewBoxWidth = 4000
const viewBoxHeight = 4000

// Calculate minor interval
const minorInterval = finalConfig.majorLineInterval / finalConfig.majorMinorRatio
---

<svg
  viewBox={`0 0 ${viewBoxWidth} ${viewBoxHeight}`}
  width={viewBoxHeight}
  height={viewBoxHeight}
  class={className}
  data-cutting-mat
>
  <g stroke="currentColor" fill="none" stroke-width="1">
    <!-- Coordinate axes -->
    <Axes
      width={viewBoxWidth}
      height={viewBoxHeight}
      opacity={finalConfig.majorOpacity}
      strokeWidth={finalConfig.majorStrokeWidth}
    />

    <!-- Teeth marks on x-axis (optional) -->
    {
      finalConfig.showTeeth && (
        <TeethMarks
          width={viewBoxWidth}
          height={viewBoxHeight}
          minorInterval={minorInterval}
          opacity={finalConfig.majorOpacity}
          strokeWidth={finalConfig.minorStrokeWidth}
        />
      )
    }

    <!-- Vertical and horizontal grid lines -->
    <GridLines
      width={viewBoxWidth}
      height={viewBoxHeight}
      majorLineInterval={finalConfig.majorLineInterval}
      {minorInterval}
      majorOpacity={finalConfig.majorOpacity}
      minorOpacity={finalConfig.minorOpacity}
      majorStrokeWidth={finalConfig.majorStrokeWidth}
      minorStrokeWidth={finalConfig.minorStrokeWidth}
    />

    <!-- Half circles at origin -->
    <Arcs
      width={viewBoxWidth}
      height={viewBoxHeight}
      arcCount={finalConfig.arcCount}
      arcRadiusInterval={finalConfig.arcRadiusInterval}
      majorLineInterval={finalConfig.majorLineInterval}
      opacity={finalConfig.majorOpacity}
      strokeWidth={finalConfig.majorStrokeWidth}
    />

    <!-- Diagonal angle lines -->
    <AngleLines
      width={viewBoxWidth}
      height={viewBoxHeight}
      angleLineCount={finalConfig.angleLineCount}
      opacity={finalConfig.majorOpacity}
      strokeWidth={finalConfig.majorStrokeWidth}
    />

    <!-- Angle labels -->
    <AngleLabels
      width={viewBoxWidth}
      height={viewBoxHeight}
      angleLineCount={finalConfig.angleLineCount}
      angleLabelArcIndex={finalConfig.angleLabelArcIndex}
      majorLineInterval={finalConfig.majorLineInterval}
      labelOpacity={finalConfig.labelOpacity}
    />

    <!-- Angle mark arcs -->
    <AngleMarks
      width={viewBoxWidth}
      height={viewBoxHeight}
      angleLineCount={finalConfig.angleLineCount}
      {minorInterval}
      angleMarkRadius={finalConfig.angleMarkRadius}
      opacity={finalConfig.majorOpacity}
      strokeWidth={finalConfig.majorStrokeWidth}
    />
  </g>
</svg>

<style>
  [data-cutting-mat] {
    color: var(--color-primary);
  }
</style>
